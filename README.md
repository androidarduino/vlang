# C语言编译器 (C-to-x86-64)

一个用C语言编写的教学型C编译器，将C代码编译为x86-64汇编。

**版本**: 0.4-alpha  
**状态**: 🚧 积极开发中  
**完成度**: 56% ✨  
**最后更新**: 2025-10-04

---

## 🎯 项目目标

构建一个功能完整的C语言编译器，支持：
- ✅ 完整的词法和语法分析
- ✅ 语义分析和类型检查
- ✅ x86-64汇编代码生成
- ✅ 基础的C语言特性

---

## ⚡ 快速开始

### 编译编译器
```bash
make
```

### 编译C程序
```bash
./cc your_program.c
./output
echo $?  # 查看返回值
```

### 示例程序
```c
// example.c
int main() {
    int x = 10;
    int y = 20;
    return x + y;  // 返回 30
}
```

```bash
./cc example.c
./output
# 输出: (退出码 30)
```

---

## ✅ 当前支持的功能 (56%)

### 基础类型
- ✅ int, float, char, void

### 运算符 ✨
- ✅ 算术: `+`, `-`, `*`, `/`, `%`
- ✅ 比较: `==`, `!=`, `<`, `>`, `<=`, `>=`
- ✅ 逻辑: `&&`, `||`, `!`
- ✅ 一元: `-` (取负)
- ✅ **递增递减**: `++i`, `i++`, `--i`, `i--` ✨
- ✅ **三元运算符**: `a ? b : c` ✨

### 控制流
- ✅ `if` / `if-else`
- ✅ `while` 循环
- ✅ `for` 循环
- ✅ `break` 语句 ✨
- ✅ `continue` 语句 ✨

### 函数
- ✅ 函数定义和调用
- ✅ 参数传递
- ✅ 返回值

### 数组 🌟
- ✅ 一维数组（完整支持）
- ✅ 多维数组（2D/3D/4D+）`int m[2][3]; m[i][j] = x;` ✨
- ✅ 数组初始化列表 `int arr[] = {1, 2, 3};`
- ✅ 多维数组初始化 `int m[2][2] = {{1,2},{3,4}};` ✨

### 指针 ✨
- ✅ 指针变量声明 `int *p` ✨
- ✅ 取地址和解引用 `&x`, `*p`
- ✅ 多级指针 `int **pp` ✨
- ✅ 指针比较 `p == q`, `p < q` ✨
- ✅ 空指针 `p = 0`, `p == 0` ✨
- ✅ **指针算术** `p+2`, `p-1` ✨ **自动缩放！**

### 结构体
- ✅ 结构体定义
- ✅ 变量声明
- ✅ 成员访问 `p.x = 10;`

### 字符串
- ✅ 字符串字面量 `"Hello"`

---

## ❌ 主要未实现功能

### 高优先级（核心缺失）
- ❌ `do-while` 循环
- ❌ `switch-case` 语句
- ❌ 复合赋值 `+=`, `-=`, `*=`, `/=`, `%=`

### 中优先级（常用功能）
- ❌ 位运算符 `&`, `|`, `^`, `~`, `<<`, `>>`
- ❌ `typedef`, `enum`, `union`
- ❌ 全局变量和静态变量
- ❌ 指针的指针算术优化

### 低优先级（高级功能）
- ❌ 预处理器 `#include`, `#define`
- ❌ 标准库函数
- ❌ 函数指针
- ❌ 可变参数

完整列表请查看 [IMPLEMENTATION_STATUS.md](IMPLEMENTATION_STATUS.md)

---

## 📊 项目统计

| 指标 | 数值 |
|------|------|
| 总代码行数 | ~4,000 行 |
| 已实现特性 | 53/95 (56%) |
| 部分实现 | 3 (3%) |
| 未实现 | 39 (41%) |
| 开发时间 | ~86 小时 |

---

## 🏗️ 架构

### 编译流程
```
C源代码
   ↓
[1. 词法分析] (Lexer)
   ↓
Token流
   ↓
[2. 语法分析] (Parser)
   ↓
抽象语法树 (AST)
   ↓
[3. 语义分析] (Semantic Analyzer)
   ↓
带类型信息的AST
   ↓
[4. 代码生成] (Code Generator)
   ↓
x86-64汇编
   ↓
[5. 汇编链接] (as + ld)
   ↓
可执行文件
```

### 目录结构
```
compiler/
├── src/
│   ├── lexer/          # 词法分析器
│   ├── parser/         # 语法分析器
│   ├── ast/            # AST节点定义
│   ├── semantic/       # 语义分析
│   │   ├── types.c     # 类型系统
│   │   └── symbol_table.c  # 符号表
│   └── codegen/        # 代码生成
├── include/            # 头文件
├── examples/           # 示例程序
├── build/              # 编译产物
└── Makefile
```

---

## 🧪 测试

### 运行示例
```bash
# 基础算术
./cc examples/arithmetic.c && ./output

# 数组操作
./cc examples/array_test.c && ./output

# 控制流
./cc examples/control_flow.c && ./output
```

### 测试覆盖
- ✅ 一维数组：完整测试
- ✅ 结构体：基础功能测试
- ✅ 控制流：if/while/for测试
- ✅ 函数：参数和返回值测试

---

## 🐛 已知问题

### 当前限制
1. ⚠️ 结构体成员类型硬编码为 int
2. ⚠️ 结构体成员偏移硬编码（仅支持x/y）
3. ⚠️ 多维数组初始化后访问需要进一步优化
4. ⚠️ 递增/递减仅支持变量标识符

### 技术债务
- 需要重构 declarator 处理逻辑
- 类型系统需要扩展
- 错误处理机制需要改进
- 缺少警告系统

详见 [IMPLEMENTATION_STATUS.md](IMPLEMENTATION_STATUS.md)

---

## 🔄 最近更新

### v0.4-alpha (2025-10-04) ✨ **重大更新！**
- ✅ **新增**: 递增递减运算符 `++i`, `i++`, `--i`, `i--`
- ✅ **新增**: 三元运算符 `a ? b : c`
- ✅ **新增**: 多维数组访问 `matrix[i][j]`, `cube[i][j][k]`
- ✅ **新增**: 多维数组初始化 `{{1,2},{3,4}}`
- ✅ **改进**: 指针算术自动元素大小缩放
- ✅ **完成度**: 39% → **56%** (+17%)

### v0.3-alpha (2025-10-04)
- ✅ **修复**: 结构体变量声明超时
- ✅ **修复**: 结构体成员访问无限递归
- ✅ **实现**: 结构体成员访问代码生成
- ✅ **修复**: 多维数组段错误
- ✅ **改进**: 多维数组完整声明支持

### v0.2-alpha
- ✅ 一维数组完整实现
- ✅ 数组初始化列表
- ✅ 字符串字面量支持

### v0.1-alpha
- ✅ 基础编译流程
- ✅ 基础类型和运算符
- ✅ 控制流语句
- ✅ 函数定义和调用

详见 [ALL_FIXES_COMPLETE.md](ALL_FIXES_COMPLETE.md)

---

## 🚀 开发路线图

### 第一阶段：完善基础功能 ✅ (已完成 95%)
- [x] 结构体基础功能
- [x] 多维数组声明和访问 ✨
- [x] break / continue ✨
- [x] 指针变量声明和算术 ✨
- [x] 递增/递减运算符 ✨
- [x] 三元运算符 ✨

### 第二阶段：增强表达式 (进行中 40%)
- [ ] do-while 循环 🔴 (下一步)
- [ ] switch-case 语句
- [ ] 复合赋值运算符 `+=`, `-=` 等
- [ ] 位运算符 `&`, `|`, `^`, `~`, `<<`, `>>`
- [ ] 逗号运算符

### 第三阶段：高级类型
- [ ] switch-case
- [ ] typedef
- [ ] enum / union
- [ ] 全局变量
- [ ] 静态变量

### 第四阶段：预处理和库
- [ ] 预处理器
- [ ] 基础标准库
- [ ] 多文件编译
- [ ] 链接器集成

---

## 📚 文档

### 实现状态
- [功能清单](FEATURES_CHECKLIST.md) - 所有功能的详细清单
- [完整实现状态](IMPLEMENTATION_STATUS.md) - 所有功能的详细列表

### 技术报告
- [指针算术完善](POINTER_ARITHMETIC_PERFECTED.md) - 自动缩放实现
- [多维数组完整实现](MULTIDIM_ARRAY_COMPLETE.md) - 2D/3D/4D+数组
- [递增递减和三元运算符](INCR_DECR_TERNARY_SUCCESS.md) - ++/--/? :实现
- [今日开发总结](TODAY_SUMMARY.md) - 2025-10-04完成的所有功能

### 修复报告
- [所有修复完成](ALL_FIXES_COMPLETE.md) - 最近的bug修复
- [结构体实现](STRUCT_ARRAY_FIX_REPORT.md) - 结构体功能详情

---

## 🤝 贡献

欢迎贡献！特别需要：
- 🐛 Bug报告和修复
- ✨ 新功能实现
- 📝 文档改进
- 🧪 测试用例

---

## 📄 许可

MIT License

---

## 🎓 学习资源

### 推荐阅读
- "Compilers: Principles, Techniques, and Tools" (龙书)
- "Engineering a Compiler" (鲸书)
- "Modern Compiler Implementation in C" (虎书)

### 相关技术
- x86-64 汇编 (System V AMD64 ABI)
- Flex/Bison (词法/语法分析)
- 编译器优化技术

---

## 📞 联系

- 项目：C-to-x86-64 Compiler
- 状态：积极开发中
- 版本：0.4-alpha
- 完成度：56%

---

**⚠️ 警告**: 这是一个教学项目，不建议用于生产环境。

**🎯 目标**: 通过实现编译器深入理解编译原理和代码生成技术。

---

Made with ❤️ by the Compiler Team
